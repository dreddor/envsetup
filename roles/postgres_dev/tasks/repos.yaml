---
- name: Create the deployments directory
  file:
    path: "{{ ansible_env.HOME }}/deployments"
    state: directory
    mode: 0755
- name: Create the workspace directory
  file:
    path: "{{ ansible_env.HOME }}/workspace"
    state: directory
- name: Cloning gpdb into ~/workspace
  git:
    repo: "https://github.com/greenplum-db/gpdb"
    dest: "{{ ansible_env.HOME }}/workspace/gpdb"
    remote: origin
    update: no
- git_config:
    name: user.email
    repo: "{{ ansible_env.HOME }}/workspace/gpdb"
    scope: local
    value: 'tvesely@pivotal.io'
# Allows CLion to intraspect the gpdb project
- name: Add a CMakeLists.txt file to the gpdb repo
  copy:
    src: CMakeLists.gpdb
    dest: "{{ansible_env.HOME}}/workspace/gpdb/CMakeLists.txt"
    mode: 0644
    owner: "{{ansible_env.USER }}"
    group: "{{ansible_env.USER }}"
- name: Cloning gdbpg into ~/workspace
  git:
    repo: "https://github.com/tvesely/gdbpg"
    dest: "{{ ansible_env.HOME }}/workspace/gdbpg"
    remote: origin
- git_config:
    name: user.email
    repo: "{{ ansible_env.HOME }}/workspace/gdbpg"
    scope: local
    value: 'tvesely@pivotal.io'
- name: Cloning gphelpers into ~/workspace
  git:
    repo: "https://github.com/tvesely/gphelpers"
    dest: "{{ ansible_env.HOME }}/workspace/gphelpers"
    remote: origin
- git_config:
    name: user.email
    repo: "{{ ansible_env.HOME }}/workspace/gphelpers"
    scope: local
    value: 'tvesely@pivotal.io'
- name: Cloning gp-xerces into ~/workspace
  git:
    repo: "https://github.com/greenplum-db/gp-xerces"
    dest: "{{ ansible_env.HOME }}/workspace/gp-xerces"
    remote: origin
- name: Cloning gporca into ~/workspace
  git:
    repo: "https://github.com/greenplum-db/gporca"
    dest: "{{ ansible_env.HOME }}/workspace/gporca"
    remote: origin
    update: no
- git_config:
    name: user.email
    repo: "{{ ansible_env.HOME }}/workspace/gporca"
    scope: local
    value: 'tvesely@pivotal.io'
- name: Cloning postgres into ~/workspace
  git:
    repo: "https://github.com/postgres/postgres"
    dest: "{{ ansible_env.HOME }}/workspace/postgres"
    remote: origin
    update: no
  tags:
    -postgres
# Allows CLion to intraspect the postgres project
- name: Add a CMakeLists.txt file to the postgres repo
  copy:
    src: CMakeLists.postgres
    dest: "{{ansible_env.HOME}}/workspace/postgres/CMakeLists.txt"
    mode: 0644
    owner: "{{ansible_env.USER }}"
    group: "{{ansible_env.USER }}"
  tags:
    -postgres
- name: Cloning tpch-dbgen into ~/workspace
  git:
    repo: "https://github.com/electrum/tpch-dbgen"
    dest: "{{ ansible_env.HOME }}/workspace/tpch-dbgen"
    remote: origin
  tags:
      - tpch-dbgen
- name: Build and install tpch-dbgen
  command: "make -j8"
  args:
    chdir: "{{ ansible_env.HOME }}/workspace/tpch-dbgen"
  tags:
      - tpch-dbgen
- name: Run tpch data generation
  command: "./dbgen -T L -s {{tpch_datagen_scale}} -f"
  args:
    chdir: "{{ ansible_env.HOME }}/workspace/tpch-dbgen"
  tags:
      - tpch-dbgen
  when:
    - run_tpch_datagen == True
- name: Cloning pg_bsd_indent into ~/workspace
  git:
    repo: "https://git.postgresql.org/git/pg_bsd_indent"
    dest: "{{ ansible_env.HOME }}/workspace/pg_bsd_indent"
    remote: origin
  tags:
    - pg_indent
